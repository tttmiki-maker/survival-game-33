<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ç„¡äººå³¶ã‚µãƒã‚¤ãƒãƒ« - èª¿æ•´ç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #0d1117; --panel: #161b22; --text: #58a6ff; --accent: #1f6feb; --danger: #f85149; --thief: #a371f7; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #c9d1d9; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: var(--panel); padding: 25px; border-radius: 12px; border: 1px solid #30363d; }
        .btn { padding: 10px 18px; margin: 4px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; background: #21262d; color: #c9d1d9; border: 1px solid #f0f6fc1a; transition: 0.2s; }
        .btn:hover { background: #30363d; border-color: #8b949e; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: #238636; color: white; }
        .btn-thief { background: var(--thief); color: white; }
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .card { background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d; position: relative; transition: all 0.3s ease; }
        .card.my-turn { border: 2px solid var(--text); box-shadow: 0 0 10px rgba(88, 166, 255, 0.3); }
        .card.dead { opacity: 0.6; background: #250000; border-color: #500; }
        .log-container { background: #000; height: 200px; overflow-y: scroll; padding: 12px; text-align: left; font-family: 'Consolas', monospace; border-radius: 6px; border: 1px solid #30363d; color: #7ee787; margin: 10px 0; font-size: 0.85em; }
        .badge { font-size: 0.75em; padding: 2px 8px; border-radius: 10px; background: var(--accent); color: white; }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100; justify-content: center; align-items: center; }
        .modal { background: var(--panel); padding: 25px; border-radius: 10px; width: 90%; max-width: 500px; border: 1px solid var(--accent); overflow-y: auto; max-height: 80vh; }
        .result-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .result-table th, .result-table td { border: 1px solid #30363d; padding: 8px; text-align: center; }
        input[type="text"], input[type="number"] { padding: 8px; border-radius: 4px; background: #0d1117; color: white; border: 1px solid #30363d; }
        .ability-info { font-size: 0.7em; color: #8b949e; margin-bottom: 10px; line-height: 1.4; }
        #kill-alert { display: none; position: fixed; top: 20%; left: 50%; transform: translate(-50%, -50%); background: rgba(100, 0, 0, 0.9); padding: 30px; border: 2px solid red; border-radius: 10px; z-index: 200; text-align: center; box-shadow: 0 0 20px red; }
        #kill-alert h2 { margin: 0; color: white; font-size: 2em; }
    </style>
</head>
<body>

<div id="kill-alert"><h2 id="kill-msg"></h2></div>

<div class="container">
    <h1>ğŸï¸ Island Survival</h1>
    
    <div id="setup-ui">
        <div class="ability-info">
            <strong>ã€èƒ½åŠ›ä¸€è¦§ã€‘</strong><br>
            ãƒ»å¼·é­ãªèº«ä½“: é£Ÿæ–™æ¶ˆè²»1.5å€ã€‚å¤§å¤±æ•—ç¢ºç‡1/2ã€‚é¤“æ­»ä»¥å¤–ã§æ­»ãªãªã„ã€‚<br>
            ãƒ»ãƒ™ãƒ†ãƒ©ãƒ³: å®0.6ä»¥ä¸Šå…¥æ‰‹ã§ç¿Œæ—¥2å€ã€‚2æ—¥é€£ç¶šç™ºå‹•ã¯ã—ãªã„ã€‚<br>
            ãƒ»é‡£ã‚Šè·äºº: é‡£ã‚Šã§å…¥æ‰‹ã§ãã‚‹é£Ÿæ–™+1ã€‚<br>
            ãƒ»å¤±æ•—ä¿é™º: å¤§å¤±æ•—æ™‚ã€å®ãƒã‚¤ãƒ³ãƒˆ+0.2ã‚’å…¥æ‰‹ã€‚<br>
            ãƒ»ã‚¹ãƒˆãƒ¼ã‚«ãƒ¼: æ¯æ—¥ç›£è¦–å¯ã€‚ä»¥å¤–ã¯ã‚²ãƒ¼ãƒ ä¸­1å›ã®ã¿ã€‚<br>
            ãƒ»ã‚¾ãƒ³ãƒ“: æ®ºå‚·èƒ½åŠ›ã€‚æ®ºå®³æ™‚é£Ÿæ–™+3å…¥æ‰‹ã€‚æ¯æ™©30%ã§æ­»äº¡ã€‚2æ—¥å¾Œã«è˜‡ç”Ÿã€‚<br>
            ãƒ»ã‚®ãƒ–ã‚¢ãƒ³ãƒ‰ãƒ†ã‚¤ã‚¯: æ®ºå‚·èƒ½åŠ›ã€‚æ®ºå®³æ™‚é£Ÿæ–™+1ã€å®+0.8ã‚’å…¥æ‰‹ã€‚
        </div>
        <p>Status: <strong id="conn-status" style="color:orange;">Initializing...</strong></p>
        <p>Your ID: <strong id="my-id" style="color:var(--text);">---</strong></p>
        <div style="margin-bottom: 20px;"><label>åå‰: <input type="text" id="username" value="Player" style="width: 150px;"></label></div>
        <div id="connection-controls">
            <button class="btn" onclick="initHost()">éƒ¨å±‹ã‚’ä½œã‚‹(Host)</button>
            <input type="text" id="join-id" placeholder="Host IDã‚’å…¥åŠ›">
            <button class="btn" onclick="initGuest()">å‚åŠ ã™ã‚‹(Guest)</button>
        </div>
        <div id="lobby-list" style="margin-top:20px; color:#8b949e; background:#0d1117; padding:10px; border-radius:5px;"></div>
        <button id="start-btn" class="btn btn-success" style="display:none; width:100%; margin-top:15px;" onclick="startGame()">ã‚µãƒã‚¤ãƒãƒ«é–‹å§‹</button>
    </div>

    <div id="game-ui" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div><h2 id="day-label" style="display:inline;">Day 1</h2><span id="my-faction-badge" class="badge" style="margin-left:10px;">å½¹è·ç¢ºèªä¸­</span></div>
            <div id="phase-label" class="badge">ACTION PHASE</div>
        </div>

        <div id="spy-report-box" style="background: #1c2128; border: 1px solid #58a6ff; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: none;">
            <strong style="color:var(--text);">ğŸ‘ï¸ ç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆ:</strong>
            <div id="spy-report-content" style="font-size: 0.9em; margin-top:5px;"></div>
        </div>

        <div class="status-grid" id="status-grid"></div>
        <div class="log-container" id="local-log"></div>

        <div id="active-player-panels">
            <div id="action-panel" style="display:none;">
                <p><strong>ğŸ’ å®æ¢ã—</strong> <span id="veteran-bonus-label" style="color:gold; font-size:0.8em; display:none;">(ãƒ™ãƒ†ãƒ©ãƒ³åŠ¹æœä¸­ï¼æ¬¡ã¯ç™ºå‹•ã—ã¾ã›ã‚“)</span></p>
                <button class="btn" onclick="sendAction('treasure', 0.2, 0)">ã¡ã‚‡ã£ã¨(0.2)</button>
                <button class="btn" onclick="sendAction('treasure', 0.4, 20)">æ™®é€š(0.4)</button>
                <button class="btn" onclick="sendAction('treasure', 0.6, 40)">ã‹ãªã‚Š(0.6)</button>
                <button class="btn" onclick="sendAction('treasure', 0.8, 60)">æœ€å¤§é™(0.8)</button>
                <p><strong>ğŸ£ é‡£ã‚Šãƒ»ä»–</strong></p>
                <button class="btn btn-success" onclick="sendAction('fish')">é‡£ã‚Š</button>
                <button class="btn" onclick="sendAction('ability')">ç‰¹æ®Šèƒ½åŠ›ã‚’å¾—ã‚‹</button>
                <div id="thief-traps" style="display:none; border:1px solid var(--thief); padding:10px; margin-top:10px; border-radius:8px;">
                    <p style="color:var(--thief); margin-top:0;">ğŸ•µï¸ ç›—è³Šå°‚ç”¨ã‚¹ã‚­ãƒ« (å„1å›ã®ã¿)</p>
                    <button id="btn-food_terror" class="btn btn-thief" onclick="sendAction('trap', 'food_terror')">é£¯ãƒ†ãƒ­</button>
                    <button id="btn-leg_trap" class="btn btn-thief" onclick="sendAction('trap', 'leg_trap')">ãƒˆãƒ©ãƒã‚µãƒŸ</button>
                    <button id="btn-theft" class="btn btn-thief" onclick="openOverlay('theft')">çªƒç›—</button>
                    <button id="btn-extra_food" class="btn btn-thief" onclick="sendAction('trap', 'extra_food')">è¿½åŠ é£Ÿæ–™(+4)</button>
                </div>
            </div>

            <div id="rest-panel" style="display:none; text-align:center; padding:10px; background:rgba(248,81,73,0.1);">
                <p style="color:var(--danger)">âš ï¸ æ˜¨æ—¥ã®å¤§å¤±æ•—ã«ã‚ˆã‚Šè¡Œå‹•ä¸èƒ½</p>
                <p>æœ¬æ—¥ã¯ä¼‘æ¯ã—ã€ä½“èª¿ã‚’æ•´ãˆã¾ã™ã€‚</p>
                <button class="btn btn-success" onclick="sendAction('skip')">ä¼‘æ¯ã™ã‚‹</button>
            </div>

            <div id="interaction-panel" style="display:none;">
                <h3>ğŸ¤ äº¤æµãƒ»ç›£è¦–ãƒ»æŠ•ç¥¨</h3>
                <div id="spy-section" style="margin-bottom:15px; padding:10px; border:1px solid var(--text); border-radius:5px;">
                    <span id="spy-count-label"></span>
                    <button id="spy-btn" class="btn" onclick="openOverlay('spy')">ç›£è¦–ã‚’å®Ÿè¡Œ</button>
                </div>
                <div id="interact-buttons-container">
                    <div id="trade-ui">
                        ç›¸æ‰‹: <select id="give-to"></select>
                        ç‰©è³‡: <select id="give-item"><option value="food">é£Ÿæ–™</option><option value="treasure">å®</option></select>
                        é‡: <input type="number" id="give-val" value="1" min="0.1" step="0.1" style="width:50px;">
                        <button class="btn" onclick="performGive()">è­²æ¸¡</button>
                    </div>
                    <div id="kill-section" style="display:none; margin-top:10px; padding:10px; border:1px solid var(--danger); border-radius:5px;">
                        <span style="color:var(--danger)">ğŸ’€ æ®ºå®³å®Ÿè¡Œ:</span> 
                        <select id="kill-to"></select> 
                        <button id="btn-kill-exec" class="btn btn-danger" onclick="performKill()">å®Ÿè¡Œ</button>
                        <span id="kill-limit-msg" style="display:none; color:gray; font-size:0.8em;">â€»æœ¬æ—¥ã®æ®ºå®³æ ã¯çµ‚äº†ã—ã¾ã—ãŸ</span>
                    </div>
                    <div id="vote-section" style="background:rgba(248,81,73,0.1); padding:10px; border-radius:5px; margin-top:10px;">
                        è¿½æ”¾æŠ•ç¥¨: <select id="vote-to"></select> <button class="btn btn-danger" onclick="performVote()">æŠ•ç¥¨</button>
                    </div>
                </div>
                <button id="ready-btn" class="btn btn-success" style="width:100%; margin-top:15px;" onclick="markReady()">ç¿Œæ—¥ã¸</button>
                </div>
        </div>

        <div id="dead-player-panel" style="display:none; text-align:center; padding:20px; background:#161b22; border:1px solid #30363d;">
            <h3 style="color:#8b949e;">ğŸ‘» è¦³æˆ¦ä¸­</h3>
            <p id="dead-status-text">ã‚ãªãŸã¯ç¾åœ¨è¡Œå‹•ã§ãã¾ã›ã‚“ã€‚</p>
            <button id="dead-action-ok-btn" class="btn btn-success" style="display:none; width:100%; margin-top:15px;" onclick="sendAction('skip')">ç¢ºèªï¼ˆæ¬¡ã¸ï¼‰</button>
            <button id="dead-ready-btn" class="btn btn-success" style="display:none; width:100%; margin-top:15px;" onclick="markReady()">ç¿Œæ—¥ã¸ã®æº–å‚™å®Œäº†</button>
            <p id="dead-waiting-msg" style="color: gold; display:none;">âŒ› å¾…æ©Ÿä¸­...</p>
        </div>
        
        <div id="pre-result-panel" style="display:none; text-align:center; padding:30px;">
            <h2>âŒ› ã‚²ãƒ¼ãƒ çµ‚äº†</h2>
            <p id="waiting-host-msg" style="color:gold; display:none;">ãƒ›ã‚¹ãƒˆãŒçµæœã‚’å…¬é–‹ã™ã‚‹ã®ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>
            <button id="reveal-btn" class="btn btn-success" style="font-size:1.2em; padding:15px 30px; display:none;" onclick="revealResults()">çµæœã‚’å…¨å“¡ã«å…¬é–‹</button>
        </div>

        <div id="host-reset-zone" style="margin-top:20px; text-align:right; display:none;">
            <button class="btn btn-danger" onclick="emergencyReset()" style="font-size:0.7em;">âš ï¸ ç·Šæ€¥ãƒªã‚»ãƒƒãƒˆ</button>
        </div>

        <div id="result-panel" style="display:none;">
            <h2 id="victory-msg"></h2>
            <div id="score-breakdown" style="font-size:1.2em; color:var(--text); margin-bottom:15px;"></div>
            <table class="result-table">
                <thead><tr><th>åå‰</th><th>é™£å–¶</th><th>çŠ¶æ…‹</th><th>é£Ÿæ–™</th><th>å®</th><th>èƒ½åŠ›</th></tr></thead>
                <tbody id="final-body"></tbody>
            </table>
            <button id="host-lobby-btn" class="btn btn-success" style="margin-top:20px; width:100%; display:none;" onclick="emergencyReset()">ãƒ­ãƒ“ãƒ¼ã¸æˆ»ã‚‹</button>
        </div>
    </div>
</div>

<div id="spy-overlay" class="overlay"><div class="modal"><h3>ç›£è¦–å¯¾è±¡ã‚’é¸æŠ</h3><div id="spy-list"></div><button class="btn" onclick="closeOverlay()">é–‰ã˜ã‚‹</button></div></div>
<div id="theft-overlay" class="overlay"><div class="modal"><h3>çªƒç›—ã™ã‚‹ç›¸æ‰‹ã‚’é¸æŠ</h3><div id="theft-list"></div><button class="btn" onclick="closeOverlay()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div></div>

<script>
    const ABILITIES = ["å¼·é­ãªèº«ä½“", "ãƒ™ãƒ†ãƒ©ãƒ³", "é‡£ã‚Šè·äºº", "å¤±æ•—ä¿é™º", "ã‚¹ãƒˆãƒ¼ã‚«ãƒ¼ä½“è³ª", "ã‚¾ãƒ³ãƒ“", "ã‚®ãƒ–ã‚¢ãƒ³ãƒ‰ãƒ†ã‚¤ã‚¯"];
    let peer = new Peer({ host: '0.peerjs.com', port: 443, secure: true });
    let myId, connections = [], hostConn = null, isHost = false;
    let gameState = { players: [], day: 1, phase: 'setup', turnIdx: -1, traps: { foodTerror: false, legTrap: false, nextLegTrap: false, theftTargetId: null }, trapUsed: { food_terror: false, leg_trap: false, theft: false, extra_food: false }, history: [], resultData: null, dailyKillCount: 0 };
    let mySpyUsedGlobal = false, stalkerTargetId = null, currentSpyReport = "", amIReady = false, lastSyncedDay = 0;

    peer.on('open', id => { myId = id; document.getElementById('my-id').innerText = id; document.getElementById('conn-status').innerText = "Online"; document.getElementById('conn-status').style.color = "#7ee787"; });
    peer.on('connection', conn => { if (isHost) { connections.push(conn); conn.on('data', d => handleData(d, conn)); setTimeout(() => sync(), 500); } });

    function initHost() { isHost = true; addPlayer(myId, document.getElementById('username').value || "Host"); document.getElementById('start-btn').style.display = 'block'; document.getElementById('connection-controls').style.display = 'none'; document.getElementById('host-reset-zone').style.display = 'block'; updateUI(); }
    function initGuest() { const tid = document.getElementById('join-id').value; if(!tid) return; hostConn = peer.connect(tid); hostConn.on('open', () => { document.getElementById('connection-controls').style.display = 'none'; hostConn.send({ type: 'join', name: document.getElementById('username').value || "Guest" }); }); hostConn.on('data', d => handleData(d)); }
    
    function sync() { if (isHost) { connections.forEach(c => c.send({ type: 'sync', state: gameState })); updateUI(); } }

    function handleData(data, conn) {
        if (isHost && data.type === 'join') { addPlayer(conn.peer, data.name); sync(); }
        if (data.type === 'sync') { 
            if (data.state.day !== lastSyncedDay) { amIReady = false; lastSyncedDay = data.state.day; }
            gameState = data.state; 
            updateUI(); 
        }
        if (data.type === 'kill_alert') showKillAlert(data.msg);

        if (isHost) {
            if (data.type === 'action') processAction(data);
            if (data.type === 'ready') { const p = gameState.players.find(x => x.id === data.pId); if(p) p.ready = true; checkPhaseEnd(); }
            if (data.type === 'give') {
                const f = gameState.players.find(x => x.id === data.from), t = gameState.players.find(x => x.id === data.to);
                if(f[data.item] >= data.val) { f[data.item] -= data.val; t[data.item] += data.val; pushLog(`${f.name}ãŒ${t.name}ã¸è­²æ¸¡`, "#58a6ff", f.id); pushLog(`${f.name}ã‹ã‚‰å—é ˜`, "#58a6ff", t.id); sync(); }
            }
            if (data.type === 'kill') {
                if (gameState.dailyKillCount >= 1) return;
                const f = gameState.players.find(x => x.id === data.from), t = gameState.players.find(x => x.id === data.to);
                if (t.ability === "å¼·é­ãªèº«ä½“") { pushLog(`ğŸ’€ ${t.name}ã¯è¥²æ’ƒã‚’è€ãˆãŸï¼`, "#7ee787", t.id); pushLog(`ğŸ’€ æ®ºå®³å¤±æ•—ï¼ˆå¼·é­ï¼‰`, "#f85149", f.id); } 
                else { 
                    t.alive = false; 
                    t.ready = true; 
                    gameState.dailyKillCount = 1; 
                    pushLog(`ğŸ’€ äº‹ä»¶ï¼š${f.name}ãŒ${t.name}ã‚’æ®ºå®³ã—ãŸ`, "#f85149"); 
                    broadcastKillAlert(`${f.name} ãŒ ${t.name} ã‚’æ®ºå®³ã—ã¾ã—ãŸï¼`); 
                }
                if (f.ability === "ã‚¾ãƒ³ãƒ“") f.food += 3; if (f.ability === "ã‚®ãƒ–ã‚¢ãƒ³ãƒ‰ãƒ†ã‚¤ã‚¯") { f.food += 1; f.treasure += 0.8; }
                sync();
                checkPhaseEnd(); 
            }
            if (data.type === 'vote') {
                const target = gameState.players.find(x => x.id === data.to);
                if (target.faction === 'thief') { pushLog(`ğŸ¯ è¿½æ”¾æˆåŠŸï¼`, "gold"); finishGame("research_win"); } else { pushLog(`ğŸš« è¿½æ”¾å¤±æ•—...`, "red"); finishGame("thief_win"); }
            }
            if (data.type === 'spy_request') {
                const target = gameState.players.find(x => x.id === data.targetId);
                let lastAct = target.yesterdayAction;
                let displayAct = "ãã®ä»–ï¼ˆä¼‘æ¯/ç½ /èƒ½åŠ›ï¼‰";
                if (lastAct === "é‡£ã‚Š") displayAct = "é‡£ã‚Š";
                if (lastAct === "å®æ¢ã—" || lastAct === "å¤§å¤±æ•—") displayAct = "å®æ¢ã—";
                
                const report = `ã€ç›£è¦–ã€‘ ${target.name} | é£Ÿæ–™:${target.food.toFixed(1)} | å®:${target.treasure.toFixed(1)} | èƒ½åŠ›:${target.ability} | æ˜¨æ—¥:${displayAct}`;
                if (conn) conn.send({ type: 'spy_result', report, targetId: target.id }); else handleData({ type: 'spy_result', report, targetId: target.id });
            }
        }
        if (data.type === 'spy_result') { const me = gameState.players.find(x => x.id === myId); if(me && me.ability === "ã‚¹ãƒˆãƒ¼ã‚«ãƒ¼ä½“è³ª") stalkerTargetId = data.targetId; else mySpyUsedGlobal = true; currentSpyReport = data.report; updateUI(); }
    }

    function broadcastKillAlert(msg) { if(isHost) { connections.forEach(c => c.send({ type: 'kill_alert', msg })); showKillAlert(msg); } }
    function showKillAlert(msg) { const el = document.getElementById('kill-alert'); document.getElementById('kill-msg').innerText = msg; el.style.display = 'block'; setTimeout(() => { el.style.display = 'none'; }, 5000); }
    function addPlayer(id, name) { gameState.players.push({ id, name, isCPU: false, food: 3, treasure: 0, ap: 1, ability: "ãªã—", alive: true, ready: false, faction: 'research', lastAction: "æœªè¡Œå‹•", yesterdayAction: "æœªè¡Œå‹•", failFlag: false, veteranActive: false, veteranNext: false, zombieReviveDay: -1 }); }

    function startGame() {
        while (gameState.players.length < 4) { let cid = "CPU"+Math.random(); gameState.players.push({ id: cid, name: "CPU-"+(gameState.players.length+1), isCPU: true, food: 3, treasure: 0, ap: 1, ability: "ãªã—", alive: true, ready: false, faction: 'research', lastAction: "æœªè¡Œå‹•", yesterdayAction: "æœªè¡Œå‹•", failFlag: false, veteranActive: false, veteranNext: false, zombieReviveDay: -1 }); }
        gameState.players[Math.floor(Math.random()*gameState.players.length)].faction = 'thief';
        gameState.phase = 'action'; gameState.day = 1; gameState.history = []; gameState.turnIdx = -1;
        gameState.trapUsed = { food_terror: false, leg_trap: false, theft: false, extra_food: false };
        gameState.traps = { foodTerror: false, legTrap: false, nextLegTrap: false, theftTargetId: null };
        gameState.dailyKillCount = 0; currentSpyReport = ""; mySpyUsedGlobal = false; stalkerTargetId = null; 
        amIReady = false; lastSyncedDay = 1; 
        pushLog("=== ã‚µãƒã‚¤ãƒãƒ«é–‹å§‹ ===", "gold"); sync(); nextTurn();
    }

    function emergencyReset() { if(!isHost) return; gameState.phase = 'setup'; gameState.history = []; gameState.day = 1; gameState.turnIdx = -1; currentSpyReport = ""; stalkerTargetId = null; mySpyUsedGlobal = false; amIReady = false; lastSyncedDay = 1; gameState.players = gameState.players.filter(p => !p.isCPU); gameState.players.forEach(p => { Object.assign(p, { food: 3, treasure: 0, ap: 1, ability: "ãªã—", alive: true, ready: false, faction: 'research', lastAction: "æœªè¡Œå‹•", yesterdayAction: "æœªè¡Œå‹•", failFlag: false, veteranActive: false, veteranNext: false, zombieReviveDay: -1 }); }); sync(); }

    function processAction(data) {
        const p = gameState.players.find(x => x.id === (data.playerId || gameState.players[gameState.turnIdx].id));
        if(!p) return; p.ap = 0;
        if (!p.alive) { p.lastAction = "ä¼‘æ¯(æ­»äº¡)"; } // æ­»è€…ã¯è‡ªå‹•çš„ã«ã‚¹ã‚­ãƒƒãƒ—ï¼ˆä¼‘æ¯ï¼‰
        else if (data.action === 'treasure') {
            let fp = data.prob; if (gameState.traps.legTrap) fp *= 2; if (p.ability === "å¼·é­ãªèº«ä½“") fp /= 2;
            if (Math.random()*100 < fp) { p.lastAction = "å¤§å¤±æ•—"; p.failFlag = true; if (p.ability === "å¤±æ•—ä¿é™º") p.treasure += 0.2; pushLog(`å¤§å¤±æ•—ã—ãŸï¼`, "#f85149", p.id); } 
            else { let gain = data.val; if(p.veteranActive) gain *= 2; p.treasure += gain; p.lastAction = "å®æ¢ã—"; if (!p.veteranActive && p.ability === "ãƒ™ãƒ†ãƒ©ãƒ³" && gain >= 0.6) p.veteranNext = true; pushLog(`å®å…¥æ‰‹(+${gain.toFixed(1)})`, "#7ee787", p.id); }
        } else if (data.action === 'fish') { let count = Math.floor(Math.random()*3)+1; if(p.ability === "é‡£ã‚Šè·äºº") count += 1; p.food += count; p.lastAction = "é‡£ã‚Š"; pushLog(`é­šã‚’${count}åŒ¹é‡£ã£ãŸ`, "#7ee787", p.id); } 
        else if (data.action === 'ability') { p.ability = ABILITIES[Math.floor(Math.random()*ABILITIES.length)]; p.lastAction = "èƒ½åŠ›å¤‰æ›´"; pushLog(`èƒ½åŠ›ã€${p.ability}ã€‘ã‚’å¾—ãŸ`, "#7ee787", p.id); } 
        else if (data.action === 'trap') {
            if (!gameState.trapUsed[data.val]) {
                gameState.trapUsed[data.val] = true;
                // å¤‰æ›´ï¼šæœ¬äººã®ãƒ­ã‚°ã«ã ã‘è¡¨ç¤ºã™ã‚‹ï¼ˆtoIdã‚’æŒ‡å®šï¼‰
                if (data.val === 'food_terror') { gameState.traps.foodTerror = true; pushLog(`ğŸ” é£¯ãƒ†ãƒ­ã‚’ä»•æ›ã‘ã¾ã—ãŸ`, "orange", p.id); } 
                else if (data.val === 'leg_trap') { gameState.traps.nextLegTrap = true; pushLog(`âš™ï¸ ãƒˆãƒ©ãƒã‚µãƒŸã‚’è¨­ç½®ã—ã¾ã—ãŸ`, "orange", p.id); } 
                else if (data.val === 'theft') { gameState.traps.theftTargetId = data.targetId; pushLog(`ğŸ•µï¸ çªƒç›—ã‚’äºˆç´„ã—ã¾ã—ãŸ`, "orange", p.id); } 
                else if (data.val === 'extra_food') { p.food += 4; pushLog(`ğŸ– è¿½åŠ é£Ÿæ–™(+4)ã‚’ç¢ºä¿`, "#7ee787", p.id); }
                p.lastAction = "ç½ è¨­ç½®";
            }
        } else if (data.action === 'skip') { p.lastAction = "ä¼‘æ¯"; p.failFlag = false; if(p.alive) pushLog(`ä½“èª¿å›å¾©`, "#7ee787", p.id); }
        
        sync(); 
        setTimeout(nextTurn, 500); 
    }

    function nextTurn() {
        if (!isHost) return; 
        gameState.turnIdx++;

        if (gameState.turnIdx >= gameState.players.length) { 
            gameState.phase = 'interaction'; 
            if (gameState.traps.theftTargetId) {
                const thief = gameState.players.find(x => x.faction === 'thief'), victim = gameState.players.find(x => x.id === gameState.traps.theftTargetId);
                if (thief && victim && victim.treasure >= 0.4) { victim.treasure -= 0.4; thief.treasure += 0.4; pushLog(`ğŸ•µï¸ çªƒç›—è¢«å®³ï¼`, "orange", victim.id); pushLog(`ğŸ•µï¸ çªƒç›—æˆåŠŸï¼`, "orange", thief.id); }
                gameState.traps.theftTargetId = null;
            }
            gameState.players.forEach(p => { p.ready = p.isCPU || !p.alive; });
            sync(); return; 
        }

        const n = gameState.players[gameState.turnIdx];
        if (!n.alive) {
            // æ­»è€…ã¯å³åº§ã«ä¼‘æ¯ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰æ‰±ã„ã¨ã—ã¦å‡¦ç†
            setTimeout(() => processAction({action:'skip', playerId:n.id}), 100);
            return;
        }

        if (n.isCPU) { 
            if(n.failFlag) setTimeout(()=>processAction({action:'skip',playerId:n.id}), 1000); 
            else setTimeout(()=>processAction({action: n.food<2?'fish':'treasure', val:0.4, prob:20, playerId:n.id}), 1000); 
        } else { sync(); }
    }

    function checkPhaseEnd() { 
        if (gameState.phase !== 'interaction') return;
        if (gameState.players.every(p => p.ready)) endDay(); else sync(); 
    }

    function endDay() {
        if (!isHost) return;
        gameState.players.forEach(p => {
            p.veteranActive = p.veteranNext; p.veteranNext = false;
            
            // ã‚¾ãƒ³ãƒ“å¾©æ´»å‡¦ç†
            if (p.zombieReviveDay === gameState.day) { p.alive = true; p.zombieReviveDay = -1; pushLog(`ğŸ§Ÿ ${p.name}è˜‡ç”Ÿï¼`, "#a371f7"); }
            
            // é£Ÿæ–™æ¶ˆè²»å‡¦ç†ï¼ˆç”Ÿãã¦ã„ã‚‹äººã ã‘æ¶ˆè²»ã™ã‚‹ï¼ã‚¾ãƒ³ãƒ“ä»®æ­»çŠ¶æ…‹ã¯æ¶ˆè²»ã—ãªã„ï¼‰
            if (p.alive) {
                let con = gameState.traps.foodTerror ? 2.0 : (p.ability === "å¼·é­ãªèº«ä½“" ? 1.5 : 1.0);
                p.food -= con; 
                if (p.food < 0) { 
                    p.alive = false; 
                    pushLog(`ğŸ’€ ${p.name}ãŒé¤“æ­»ã—ãŸ`, "red"); 
                }
                // ã‚¾ãƒ³ãƒ“çªç„¶æ­»åˆ¤å®š
                if (p.alive && p.ability === "ã‚¾ãƒ³ãƒ“" && Math.random() < 0.3) { 
                    p.alive = false; 
                    p.zombieReviveDay = gameState.day + 2; 
                    pushLog(`ğŸ§Ÿ ${p.name}çªç„¶æ­»`, "#a371f7"); 
                }
            }
            // æ­»ã‚“ã§ã„ã‚‹äºº(ã‚¾ãƒ³ãƒ“å¾…æ©Ÿå«ã‚€)ã¯é£Ÿæ–™æ¸›ã‚‰ãªã„ã®ã§ä½•ã‚‚ã—ãªã„
        });
        
        if (gameState.day >= 10) return finishGame("timeup");
        
        gameState.day++; 
        gameState.phase = 'action'; 
        gameState.turnIdx = -1;
        gameState.traps.foodTerror = false; 
        gameState.traps.legTrap = gameState.traps.nextLegTrap; 
        gameState.traps.nextLegTrap = false;
        gameState.dailyKillCount = 0; 
        
        gameState.players.forEach(p => { p.yesterdayAction = p.lastAction; p.lastAction = "æœªè¡Œå‹•"; p.ready = false; });
        
        amIReady = false; 
        pushLog(`--- Day ${gameState.day} é–‹å§‹ ---`, "gold"); 
        
        // ã“ã“ã§åŒæœŸã™ã‚‹ã“ã¨ã§ã€æ­»è€…ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ï¼‰ã‚’å…¨å“¡ã«æ›´æ–°
        sync();
        nextTurn();
    }

    function finishGame(reason) {
        let surRes = 0, resTr = 0; gameState.players.forEach(p => { if (p.faction === 'research' && p.alive) { surRes++; resTr += p.treasure; } });
        let score = (surRes * 10) + (resTr * 6);
        gameState.resultData = { msg: score >= 50 ? "ğŸ‰ èª¿æŸ»éšŠã®å‹åˆ©ï¼" : "ğŸ’€ ç›—è³Šã®å‹åˆ©ï¼", score: score.toFixed(1), players: JSON.parse(JSON.stringify(gameState.players)) };
        gameState.phase = 'pre_result'; sync();
    }

    function revealResults() { if(isHost) { gameState.phase = 'result'; sync(); } }

    function updateUI() {
        const me = gameState.players.find(x => x.id === myId); if (!me) return;
        if (gameState.phase === 'action') { amIReady = false; }

        document.getElementById('setup-ui').style.display = 'none';
        document.getElementById('game-ui').style.display = 'block';
        document.getElementById('result-panel').style.display = 'none';
        document.getElementById('pre-result-panel').style.display = 'none';
        document.getElementById('active-player-panels').style.display = 'none';
        document.getElementById('dead-player-panel').style.display = 'none';

        if (gameState.phase === 'setup') {
            document.getElementById('setup-ui').style.display = 'block';
            document.getElementById('game-ui').style.display = 'none';
            document.getElementById('lobby-list').innerHTML = "<strong>å‚åŠ è€…ãƒªã‚¹ãƒˆ:</strong><br>" + gameState.players.map(p => `ãƒ»${p.name} ${p.id===myId?'(è‡ªåˆ†)':''}`).join("<br>");
            return;
        }

        if (gameState.phase === 'result' && gameState.resultData) {
            const rd = gameState.resultData; document.getElementById('victory-msg').innerText = rd.msg; document.getElementById('score-breakdown').innerText = `æœ€çµ‚ã‚¹ã‚³ã‚¢: ${rd.score}`;
            const body = document.getElementById('final-body'); body.innerHTML = "";
            rd.players.forEach(p => body.innerHTML += `<tr><td>${p.name}</td><td>${p.faction==='thief'?'ç›—è³Š':'èª¿æŸ»éšŠ'}</td><td>${p.alive?'ç”Ÿå­˜':'æ­»äº¡'}</td><td>${p.food.toFixed(1)}</td><td>${p.treasure.toFixed(1)}</td><td>${p.ability}</td></tr>`);
            document.getElementById('result-panel').style.display = 'block'; document.getElementById('status-grid').style.display = 'none';
            if(isHost) document.getElementById('host-lobby-btn').style.display = 'block';
            return;
        }

        if (gameState.phase === 'pre_result') {
            document.getElementById('pre-result-panel').style.display = 'block'; document.getElementById('status-grid').style.display = 'none';
            if (isHost) { document.getElementById('reveal-btn').style.display = 'inline-block'; document.getElementById('waiting-host-msg').style.display = 'none'; } 
            else { document.getElementById('reveal-btn').style.display = 'none'; document.getElementById('waiting-host-msg').style.display = 'block'; }
            return;
        }

        document.getElementById('status-grid').style.display = 'grid';
        document.getElementById('day-label').innerText = "Day " + gameState.day;
        document.getElementById('phase-label').innerText = gameState.phase.toUpperCase() + " PHASE";
        document.getElementById('my-faction-badge').innerText = me.faction === 'thief' ? "ğŸ•µï¸ ç›—è³Š" : "ğŸ” èª¿æŸ»éšŠ";
        document.getElementById('my-faction-badge').style.background = me.faction === 'thief' ? "var(--thief)" : "var(--accent)";
        document.getElementById('veteran-bonus-label').style.display = me.veteranActive ? 'inline' : 'none';

        if (currentSpyReport) { document.getElementById('spy-report-box').style.display = 'block'; document.getElementById('spy-report-content').innerText = currentSpyReport; } else { document.getElementById('spy-report-box').style.display = 'none'; }

        const grid = document.getElementById('status-grid'); grid.innerHTML = "";
        gameState.players.forEach((p, i) => {
            const act = (gameState.phase === 'action' && i === gameState.turnIdx);
            // ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‰ã®è¡¨ç¤ºæ›´æ–°ï¼šæ­»ã‚“ã§ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã‚ˆã†ã«ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
            grid.innerHTML += `<div class="card ${act?'my-turn':''} ${p.alive?'':'dead'}"><strong>${p.name}</strong> ${p.ready?'âœ…':''}<br>${p.alive?'â¤ï¸ ç”Ÿå­˜': (p.zombieReviveDay>0?'ğŸ§Ÿ è˜‡ç”Ÿå¾…ã¡':'ğŸ’€ æ­»äº¡')}<br>${p.id===myId?`ğŸ–:${p.food.toFixed(1)} ğŸ’:${p.treasure.toFixed(1)}<br><small>${p.ability}</small>`:`ğŸ–:?? ğŸ’:??`}</div>`;
        });

        document.getElementById('local-log').innerHTML = gameState.history.filter(h => h.to === null || h.to === myId).map(h => `<div style="color:${h.color}">[Day${h.day}] ${h.msg}</div>`).join("");
        document.getElementById('local-log').scrollTop = 99999;

        const isMyActionTurn = (gameState.phase === 'action' && gameState.players[gameState.turnIdx]?.id === myId);

        if (me.alive) {
            document.getElementById('active-player-panels').style.display = 'block';
            document.getElementById('action-panel').style.display = (isMyActionTurn && !me.failFlag) ? 'block' : 'none';
            document.getElementById('rest-panel').style.display = (isMyActionTurn && me.failFlag) ? 'block' : 'none';
            
            if (me.faction === 'thief') {
                document.getElementById('thief-traps').style.display = 'block';
                document.getElementById('btn-food_terror').disabled = gameState.trapUsed.food_terror;
                document.getElementById('btn-leg_trap').disabled = gameState.trapUsed.leg_trap;
                document.getElementById('btn-theft').disabled = gameState.trapUsed.theft;
                document.getElementById('btn-extra_food').disabled = gameState.trapUsed.extra_food;
            }

            if (gameState.phase === 'interaction') {
                document.getElementById('interaction-panel').style.display = 'block';
                const isTrulyReady = me.ready || amIReady;
                const readyBtn = document.getElementById('ready-btn');
                readyBtn.style.display = 'block';
                if (isTrulyReady) { 
                    document.getElementById('interact-buttons-container').style.display = 'none'; 
                    readyBtn.innerText = "æº–å‚™å®Œäº† (å¾…æ©Ÿä¸­...)";
                    readyBtn.disabled = true;
                    document.getElementById('spy-btn').disabled = true; 
                } 
                else {
                    document.getElementById('interact-buttons-container').style.display = 'block'; 
                    readyBtn.innerText = "ç¿Œæ—¥ã¸";
                    readyBtn.disabled = false;
                    
                    const gTo = document.getElementById('give-to'), kTo = document.getElementById('kill-to'), vTo = document.getElementById('vote-to');
                    gTo.innerHTML = kTo.innerHTML = vTo.innerHTML = "";
                    gameState.players.forEach(p => { if(p.id !== myId && p.alive) { const o = `<option value="${p.id}">${p.name}</option>`; gTo.innerHTML += o; kTo.innerHTML += o; vTo.innerHTML += o; } });
                    const canKill = (me.ability === "ã‚¾ãƒ³ãƒ“" || me.ability === "ã‚®ãƒ–ã‚¢ãƒ³ãƒ‰ãƒ†ã‚¤ã‚¯"); document.getElementById('kill-section').style.display = canKill ? 'block' : 'none';
                    document.getElementById('btn-kill-exec').disabled = gameState.dailyKillCount >= 1; document.getElementById('kill-limit-msg').style.display = gameState.dailyKillCount >= 1 ? 'inline' : 'none';
                    if (me.ability === "ã‚¹ãƒˆãƒ¼ã‚«ãƒ¼ä½“è³ª") { document.getElementById('spy-count-label').innerText = stalkerTargetId ? "ç›£è¦–: å›ºå®š" : "ç›£è¦–: æ¯æ—¥å¯"; document.getElementById('spy-btn').disabled = false; } 
                    else { document.getElementById('spy-count-label').innerText = `ç›£è¦–: ${mySpyUsedGlobal?0:1}å›`; document.getElementById('spy-btn').disabled = mySpyUsedGlobal; }
                }
            } else { document.getElementById('interaction-panel').style.display = 'none'; }
        } else {
            document.getElementById('dead-player-panel').style.display = 'block';
            if (isMyActionTurn) { document.getElementById('dead-status-text').innerText = "è¡Œå‹•é †ã§ã™ï¼ˆæ­»äº¡çŠ¶æ…‹ï¼‰"; document.getElementById('dead-action-ok-btn').style.display = 'block'; document.getElementById('dead-ready-btn').style.display = 'none'; document.getElementById('dead-waiting-msg').style.display = 'none'; } 
            else if (gameState.phase === 'interaction') { 
                document.getElementById('dead-status-text').innerText = "äº¤æµã‚¿ã‚¤ãƒ ã§ã™"; 
                const rdy = (me.ready || amIReady); 
                document.getElementById('dead-action-ok-btn').style.display = 'none'; 
                document.getElementById('dead-ready-btn').style.display = 'block'; 
                if (rdy) {
                    document.getElementById('dead-ready-btn').innerText = "æº–å‚™å®Œäº† (å¾…æ©Ÿä¸­...)";
                    document.getElementById('dead-ready-btn').disabled = true;
                } else {
                    document.getElementById('dead-ready-btn').innerText = "ç¿Œæ—¥ã¸ã®æº–å‚™å®Œäº†";
                    document.getElementById('dead-ready-btn').disabled = false;
                }
                document.getElementById('dead-waiting-msg').style.display = rdy ? 'block' : 'none'; 
            } 
            else { document.getElementById('dead-status-text').innerText = "ä»–è€…ã®è¡Œå‹•ä¸­ã§ã™"; document.getElementById('dead-action-ok-btn').style.display = 'none'; document.getElementById('dead-ready-btn').style.display = 'none'; document.getElementById('dead-waiting-msg').style.display = 'block'; }
        }
    }

    function pushLog(msg, color, toId = null) { gameState.history.push({ day: gameState.day, msg, color, to: toId }); if (isHost) sync(); }
    function sendAction(type, v1, v2) { if (isHost) processAction({ type: 'action', playerId: myId, action: type, val: v1, prob: v2 }); else hostConn.send({ type: 'action', playerId: myId, action: type, val: v1, prob: v2 }); }
    function markReady() { amIReady = true; updateUI(); if (isHost) { const me = gameState.players.find(x => x.id === myId); if(me) me.ready = true; checkPhaseEnd(); } else { hostConn.send({ type: 'ready', pId: myId }); } }
    function executeSpy(targetId) { if (isHost) handleData({ type: 'spy_request', targetId }); else hostConn.send({ type: 'spy_request', targetId }); closeOverlay(); }
    function executeTheft(targetId) { if (isHost) processAction({ type: 'action', action: 'trap', val: 'theft', targetId, playerId: myId }); else hostConn.send({ type: 'action', action: 'trap', val: 'theft', targetId, playerId: myId }); closeOverlay(); }
    function openOverlay(id) { document.getElementById(id + '-overlay').style.display = 'flex'; const list = document.getElementById(id + '-list'); list.innerHTML = ""; gameState.players.forEach(p => { if (p.id !== myId && p.alive) { if (id === 'spy' && (!stalkerTargetId || p.id === stalkerTargetId)) list.innerHTML += `<button class="btn" onclick="executeSpy('${p.id}')">${p.name}</button>`; if (id === 'theft') list.innerHTML += `<button class="btn btn-thief" onclick="executeTheft('${p.id}')">${p.name}</button>`; }}); }
    function closeOverlay() { document.querySelectorAll('.overlay').forEach(o => o.style.display = 'none'); }
    function performGive() { const p = { type: 'give', from: myId, to: document.getElementById('give-to').value, item: document.getElementById('give-item').value, val: parseFloat(document.getElementById('give-val').value) }; if (isHost) handleData(p); else hostConn.send(p); }
    function performKill() { document.getElementById('btn-kill-exec').disabled = true; const p = { type: 'kill', from: myId, to: document.getElementById('kill-to').value }; if (isHost) handleData(p); else hostConn.send(p); }
    function performVote() { const p = { type: 'vote', to: document.getElementById('vote-to').value }; if (isHost) handleData(p); else hostConn.send(p); }
</script>
</body>
</html>
